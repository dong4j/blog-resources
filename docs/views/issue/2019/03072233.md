---
title: æ‹ä¸€æ‹ async-tool çš„é—®é¢˜
date: 2019-03-07
categories:
  - Issue
tags: 
  - Issue
---

::: tip
å¤„ç†ä¸€ä¸ªå¹¶å‘é—®é¢˜
:::

<!-- more -->

æ˜¨å¤©åšå®Œç²¾å‡†è¥é”€çš„éœ€æ±‚å, ææµ‹ç‰ˆæœ¬ä¸€ç›´è¿ä¸ä¸Š MQ, ç„¶ååœ¨æœ¬åœ°å¯åŠ¨åä¹Ÿæœªå‘ç°é—®é¢˜, ç›´åˆ°ç›‘å¬çš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰æ¶ˆæ¯è€Œä¸”æ˜¯**å¤§é‡æ¶ˆæ¯**æ—¶æ‰ä¼šå‡ºç°çš„é”™è¯¯:

```java
javax.jms.JMSException: Cannot send, channel has already failed: tcp://172.31.205.58:61616
	at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:62)
	at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1409)
	at org.apache.activemq.ActiveMQConnection.ensureConnectionInfoSent(ActiveMQConnection.java:1496)
	at org.apache.activemq.ActiveMQConnection.createSession(ActiveMQConnection.java:325)
	at org.apache.activemq.pool.ConnectionPool$2.makeObject(ConnectionPool.java:105)
	at org.apache.activemq.pool.ConnectionPool$2.makeObject(ConnectionPool.java:90)
	at org.apache.commons.pool.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:1179)
	at org.apache.activemq.pool.ConnectionPool.createSession(ConnectionPool.java:142)
	at org.apache.activemq.pool.PooledConnection.createSession(PooledConnection.java:174)
	at com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer.sendMsg(JmsProducer.java:137)
	at com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer.access$100(JmsProducer.java:19)
	at com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer$2.run(JmsProducer.java:114)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
Caused by: org.apache.activemq.transport.InactivityIOException: Cannot send, channel has already failed: tcp://172.31.205.58:61616
	at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:315)
	at org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:304)
	at org.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:85)
	at org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:104)
	at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)
	at org.apache.activemq.transport.ResponseCorrelator.asyncRequest(ResponseCorrelator.java:81)
	at org.apache.activemq.transport.ResponseCorrelator.request(ResponseCorrelator.java:86)
	at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1380)
	... 13 more
```

å› æ­¤å¼€å§‹èµ°ä¸Š debug è¿™æ¡ä¸å½’è·¯...

## å®šä½é—®é¢˜

ä¸Šé¢æŠ¥çš„é”™è¯¯, ä¸€å¼€å§‹æ€€ç–‘æ˜¯ ActiveMQ æ¶ˆè´¹è€…è¿æ¥æ–­å¼€, å¯¼è‡´å‘é€ä¸äº†æ¶ˆæ¯, å› æ­¤ä¸€æ¥å°±å¼€å§‹ debug `sendMsg()` è¿™ä¸ªæœ€ç»ˆå‘é€æ¶ˆæ¯çš„æ–¹æ³•.

```java
private void sendMsg(String queue, String jsonStr) throws Exception {
    Connection connection = null;
    Session session = null;
    MessageProducer producer = null;
    try {
        //ä»è¿æ¥æ± å·¥å‚ä¸­è·å–ä¸€ä¸ªè¿æ¥
        connection = this.connectionFactory.createConnection();
        //false å‚æ•°è¡¨ç¤º ä¸ºéäº‹åŠ¡å‹æ¶ˆæ¯ï¼Œåé¢çš„å‚æ•°è¡¨ç¤ºæ¶ˆæ¯çš„ç¡®è®¤ç±»å‹
        session = connection.createSession(Boolean.FALSE, Session.AUTO_ACKNOWLEDGE);
        //PTPæ¶ˆæ¯æ–¹å¼
        Destination destination = session.createQueue(queue);
        //Destination is superinterface of Queue
        producer = createProducer(producer, session, destination);
        //map convert to javax message
        Message message = getMessage(session, jsonStr);
        producer.send(message);
        log.info("send message, producer = {}", producer.getClass());
    } finally {
        closeSession(session);
        closeConnection(connection);
    }
}
```

å…ˆè¯´è¿™ä¸ªæ–¹æ³•çš„é—®é¢˜:

å½“æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ª ActiveMQ è¿æ¥, ç„¶ååˆ›å»ºä¸€ä¸ª session, æœ€ååˆ›å»ºä¸€ä¸ª producer, æ¶ˆæ¯å‘é€å®Œæˆåå…³é—­è¿æ¥.
é¢‘ç¹çš„åˆ›å»ºå…³é—­è¿æ¥å°†æ¶ˆè€—å¤§é‡ç³»ç»Ÿèµ„æº, é™ä½æ€§èƒ½, å› æ­¤ä¸€èˆ¬ä½¿ç”¨è¿æ¥æ± æ¥ä¿å­˜è¿æ¥. 

![-w999](http://qiniu.dong4j.info/2019-07-04-15520024926324.jpg)
![-w974](http://qiniu.dong4j.info/2019-07-04-15520025329609.jpg)

ä» debug æ—¥å¿—ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥, è¿æ¥ååˆ close äº†.

å› æ­¤å°† Connection, Session, Producer è¿›è¡Œå¤ç”¨. (è¿™ä¹Ÿæ˜¯ ActiveMQ å®˜æ–¹æ¨èçš„åšæ³•).

å°†åˆ›å»º producer çš„æ•´ä¸ªæ“ä½œæ”¾åˆ° init() ä¸­, åªæ‰§è¡Œä¸€æ¬¡.

```java
private MessageProducer producer = null;

private void init() throws Exception {
    //è®¾ç½®JAVAçº¿ç¨‹æ± 
    this.threadPool = Executors.newFixedThreadPool(this.threadPoolSize);
    //ActiveMQçš„è¿æ¥å·¥å‚
    ActiveMQConnectionFactory actualConnectionFactory = new ActiveMQConnectionFactory(this.userName, this.password, this.brokerUrl);
    actualConnectionFactory.setUseAsyncSend(this.useAsyncSendForJMS);
    //Activeä¸­çš„è¿æ¥æ± å·¥å‚
    this.connectionFactory = new PooledConnectionFactory(actualConnectionFactory);
    this.connectionFactory.setCreateConnectionOnStartup(true);
    this.connectionFactory.setMaxConnections(this.maxConnections);
    this.connectionFactory.setMaximumActiveSessionPerConnection(this.maximumActiveSessionPerConnection);

    Connection connection;
    Session session;
    //ä»è¿æ¥æ± å·¥å‚ä¸­è·å–ä¸€ä¸ªè¿æ¥
    connection = this.connectionFactory.createConnection();
    //false å‚æ•°è¡¨ç¤º ä¸ºéäº‹åŠ¡å‹æ¶ˆæ¯ï¼Œåé¢çš„å‚æ•°è¡¨ç¤ºæ¶ˆæ¯çš„ç¡®è®¤ç±»å‹
    session = connection.createSession(Boolean.FALSE, Session.AUTO_ACKNOWLEDGE);
    //PTPæ¶ˆæ¯æ–¹å¼
    Destination destination = session.createQueue("BiUserStatusSignal");
    //Destination is superinterface of Queue
    producer = createProducer(producer, session, destination);
}
```

é‡å†™ `sendMsg()`

```java
private void sendMsg(String jsonStr) throws Exception {
    ActiveMQTextMessage message = new ActiveMQTextMessage();
    message.setText(jsonStr);
    producer.send(message);
    log.info("send");
}
```

å½“æˆ‘ä»¥ä¸ºå°±è¿™ä¹ˆå®¹æ˜“çš„æŠŠé—®é¢˜è§£å†³çš„æ—¶å€™, æ–°çš„é”™è¯¯åˆæ¥äº†(å¦‚æœé—®é¢˜å°±è¿™ä¹ˆè§£å†³äº†, æˆ‘ä¹Ÿä¸ä¼šå†™è¿™ä¸ªæ–‡æ¡£äº†).

```java
Caused by: org.apache.activemq.transport.InactivityIOException: Cannot send, channel has already failed: tcp://172.31.205.58:61616
	at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:315)
	at org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:304)
	at org.apache.activemq.transport.WireFormatNegotiator.sendWireFormat(WireFormatNegotiator.java:168)
	at org.apache.activemq.transport.WireFormatNegotiator.sendWireFormat(WireFormatNegotiator.java:84)
	at org.apache.activemq.transport.WireFormatNegotiator.start(WireFormatNegotiator.java:74)
	at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
	at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
	at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:273)
	... 25 more
java.lang.NullPointerException
	at com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer.sendMsg(JmsProducer.java:155)
	at com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer.access$100(JmsProducer.java:24)
	at com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer$2.run(JmsProducer.java:137)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
```

è¿™æ¬¡ä¸ä»…å‡ºç°äº† `NullPointerException`, ä»¥å‰çš„å¼‚å¸¸è¿˜æ˜¯å­˜åœ¨, ActiveMQ çš„è¿æ¥ä¾ç„¶å¾ˆå¤š

![-w368](http://qiniu.dong4j.info/2019-07-04-15520036248777.jpg)


å”¯ä¸€æ”¹å–„çš„å°±æ˜¯**å¼‚å¸¸å‡ºç°çš„é¢‘ç‡é™ä½äº†**. å› æ­¤è¿™ä¸ªä¸æ˜¯æœ€æ ¹æœ¬çš„åŸå› .

é‚£ä¹ˆæ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå‡ºç° `NullPointerException`.

ä¸Šé¢çš„ä»£ç è‚¯å®šæ˜¯æ²¡æœ‰é—®é¢˜çš„, é™¤éæ˜¯åœ¨**å¤šçº¿ç¨‹ç¯å¢ƒ**ä¸‹. 

å¦ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜:

![-w897](http://qiniu.dong4j.info/2019-07-04-15520037941428.jpg)

ğŸ˜³ğŸ˜³ å±…ç„¶èƒ½æœ‰ 40 å¤šä¸ªçº¿ç¨‹æ± ......
å¥½äº†, åŸºæœ¬çŸ¥é“ä»€ä¹ˆåŸå› å¯¼è‡´çš„äº†, **å¹¶å‘ + çº¿ç¨‹æ±  **é—®é¢˜.

çœ‹çœ‹è¿è¡Œæ—¶çš„çº¿ç¨‹:

![-w1440](http://qiniu.dong4j.info/2019-07-04-15520165022849.jpg)

åƒåœ¾å›æ”¶é¢‘ç¹, çº¿ç¨‹æ•°è¿˜åœ¨ä¸æ–­å¢é•¿.....

## è¿½è¸ªä»£ç 

åˆå§‹åŒ– producer çš„è¿æ¥æ± å°±æ˜¯ `init()` çš„è¿™æ®µä»£ç 

```java
//è®¾ç½®JAVAçº¿ç¨‹æ± 
this.threadPool = Executors.newFixedThreadPool(this.threadPoolSize);
```

èƒ½åˆå§‹åŒ–å¤šä¸ªè¿æ¥æ± ,  `init()` è‚¯å®šè¢«é”™è¯¯çš„æ‰§è¡Œäº†å¤šæ¬¡. é€šè¿‡æŸ¥çœ‹ `BiUserStatusTask` è¿™ä¸ªç±»,èƒ½æ‰§è¡Œ `init()` çš„ä¹Ÿåªæœ‰ä¸‹é¢çš„ä»£ç äº†.

```java
JmsProducerFactory jmsProducerFactory = new JmsProducerFactory(producerJmsConfig);

... 
jmsProducerFactory.start();
```

`start()` æ–¹æ³•ä¼šåˆ¤æ–­ JmsProducer æ˜¯å¦ null, ä¸º null æ‰ä¼šè°ƒç”¨ `init()` æ¥åˆ›å»ºçº¿ç¨‹æ± 

```java
public synchronized void start() {
    if(started.get()) {
        return;
    }
    //é…ç½®ä¸‹å‘åˆ°ç›¸å…³ç»„ä»¶
    deliverConfig();
    started.set(true);
}

private void deliverConfig(){
    if (jmsProducer == null) {
        jmsProducer = new JmsProducer(jmsConfig.getBrokerURL(), jmsConfig.getUserName(), jmsConfig.getPassword());
    }
}
```

æ•´ä¸ª `BiUserStatusTask` ç±»çš„ä»£ç ä¹Ÿæ²¡æœ‰çœ‹å‡ºå“ªä¸ªåœ°æ–¹ä¼šå¤šæ¬¡åˆ›å»ºçº¿ç¨‹æ± . æ²¡åŠæ³•åªæœ‰åŠ æ—¥å¿—.

![-w718](http://qiniu.dong4j.info/2019-07-04-15520047474642.jpg)

é—®é¢˜æ‰¾åˆ°äº†, æ˜¯è¿›å…¥ catch äº† ğŸ˜¥. 

![-w945](http://qiniu.dong4j.info/2019-07-04-15520049296247.jpg)

åŸæ¥æ˜¯ `JsonUtil.jsonToMap(text)` è§£ææŠ›å¼‚å¸¸äº† ğŸ˜°. (ä¸ºä»€ä¹ˆæˆ‘æ²¡æœ‰åœ¨ `BiUserStatusTask` ä¸­æ‰“æ–­ç‚¹, å› ä¸ºä¸€ç›´ä»¥ä¸ºæ˜¯ producer å‘é€æ¶ˆæ¯çš„ä»£ç æœ‰é—®é¢˜).

æœ€å¥½çš„ debug æ–¹å¼å°±æ˜¯**æ—¥å¿—**, å› ä¸º debug å¾ˆæ…¢, è€Œä¸”å¤šçº¿ç¨‹çš„æ—¶å€™å¹¶ä¸å¥½ debug. ä¸Šé¢çš„ä»£ç åœ¨ catch ä¸­ç›´æ¥å°±å‘é€å¼‚å¸¸æ¶ˆæ¯ç„¶åå…¥åº“, å¯¼è‡´æ—¥å¿—ä¸­æ²¡æœ‰é”™è¯¯ä¿¡æ¯.

::: tip æ­£ç¡®çš„åšæ³•æ˜¯
catch ä¸­ä¸€å®šè¦æ‰“å°æ—¥å¿—, å› ä¸ºè¿™ä¸ªå±äºç³»ç»Ÿå¼‚å¸¸æ—¥å¿—, æ˜¯ç»™å¼€å‘çš„äººçœ‹çš„, è€Œéœ€è¦å…¥åº“çš„æ—¥å¿—ä¸€èˆ¬éƒ½æ˜¯ä¸šåŠ¡æ—¥å¿—æˆ–è€…ä¸šåŠ¡å¼‚å¸¸æ—¥å¿—, å¼€å‘çš„æ—¶å€™è°å†å»æŸ¥ä¸€ä¸‹æ•°æ®åº“æœ‰æ²¡æœ‰å¼‚å¸¸æ—¥å¿—å•Š! ç›´æ¥æ‰“å°åˆ°æ—¥å¿—ä¸æ˜¯æ›´å¥½å—? **æ•ˆç‡å°±æ˜¯ç”Ÿå‘½**!

:::

ä¹Ÿè¯·ä¸è¦æŠŠæ‰€æœ‰ä»£ç éƒ½åŒ…è£¹åœ¨ try-catch é‡Œé¢, æœ€å¥½æŠŠå¼‚å¸¸åˆ†ç±»å¤„ç†, ä¸€ä¸ª catch å°±æŠŠæ‰€æœ‰å¼‚å¸¸æ•è·äº†å€’æ˜¯ç®€å•, ä½†æ˜¯ä¸å¥½æ’æŸ¥é—®é¢˜, ä¹Ÿä¼šå½±å“æ‰§è¡Œæ•ˆç‡.

å†™ä»£ç çš„æ—¶å€™, å°½é‡æŠŠå¼‚å¸¸æš´éœ²å‡ºæ¥, ä¸è¦å¿½ç•¥ catch. åœ¨ç¼–ç é˜¶æ®µå°±å°½å¯èƒ½å¤šçš„å¤„ç†å¼‚å¸¸, è€Œä¸æ˜¯ä¸Šçº¿äº†å†™åˆ°æ•°æ®åº“, ç„¶åç»Ÿè®¡å¼‚å¸¸æ•°æ®æ¥æŠ¥è­¦.

ä»¥å‰å†™è¿‡äº›æ–¹é¢çš„é—®é¢˜, ä¼°è®¡ä¹Ÿæ²¡äººåœ¨æ„å§.

## è¿›å…¥ä¸»é¢˜

å¥½äº†, é‡ç‚¹æ¥äº†.

catch é‡Œé¢ä¹Ÿä¼šå‘é€ MQ æ¶ˆæ¯, ä¼šä¸ä¼šæ˜¯è¿™é‡Œé¢çš„é—®é¢˜å‘¢? é‚£æˆ‘ä»¬å…ˆæ¥æ‹ä¸€æ‹ `LogSupportException.writeFuncExceptionLog()` è¿™ä¸ªæ–¹æ³•

```java
public class LogSupportException {
    private static LogService logService = LogServiceFactory.getLogService();
    
    /**
     * å°è£…é”™è¯¯ä¿¡æ¯
     */ 
    public static void writeSupportExceptionLog(Exception e, String componentName, String methodName, String className, String inputParams, String logDesc, LogSupportException.ErrorLevel errorLevel) {
        ...
        saveException(logField);
    }
    ...
}    
```

`writeSupportExceptionLog()` æ˜¯å°è£…å¤„ç†ä¿¡æ¯çš„å¤„ç† (æ€§èƒ½å¾ˆä½, å°±ä¸åæ§½äº†, è‡ªå·±å»çœ‹å§). ä¼šè°ƒç”¨ `logService.saveLog()` å‘é€å¼‚æ­¥æ¶ˆæ¯.

é‚£ä¹ˆ `logService` æ˜¯å“ªé‡Œæ¥çš„å‘¢? 

```java
private static LogService logService = LogServiceFactory.getLogService();
```

æ˜¯ä¸€ä¸ªé™æ€å±æ€§, è¿™é‡Œå¤ä¹ ä¸€ä¸‹ç±»çš„åˆå§‹åŒ–é¡ºåº.

::: tip

.java è¢«ç¼–è¯‘æˆ .class è¢« Classloader åŠ è½½åˆ° JVM çš„æ—¶å€™, é¦–å…ˆä¼šè°ƒç”¨ **static ä»£ç å— **å’Œåˆå§‹åŒ– **é™æ€å±æ€§** (è¿™ä¸ªçœ‹ 2 è€…ä»£ç çš„é¡ºåº), å¦‚æœæ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™, ä¼šå…ˆæ‰§è¡Œ**ä»£ç å—**, ç„¶åæ‰æ˜¯**æ„é€ æ–¹æ³•**. é‚£ä¹ˆé—®é¢˜æ¥äº†, å­ç±»çˆ¶ç±»åˆå§‹åŒ–çš„é¡ºåºæ˜¯ä»€ä¹ˆå‘¢?

:::

`logService` æ˜¯ä¸€ä¸ªé™æ€å±æ€§, ä¼šåœ¨è¢« JVM åŠ è½½çš„æ—¶å€™å°±åˆå§‹åŒ–, ä¸ç®¡æœ‰æ²¡æœ‰åˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹.
å› æ­¤æˆ‘ä»¬è¿›å…¥åˆ° `LogServiceFactory.getLogService()`

```java
public class LogServiceFactory {
    private static ApplicationContext context = null;
    private static LogService logService = null;
    private static LogService logServiceB = null;
    private static boolean initFlag = false;

    synchronized static void init() {
        if (!initFlag) {
            context = new ClassPathXmlApplicationContext(
                    "classpath*:applicationContext-jms.xml");
            initFlag = true;
        }
    }

    synchronized static void initLogService() {
        if (initFlag && logService == null) {
            logService = (LogService) context.getBean("logServiceConcurrent");
            logServiceB = (LogService) context.getBean("logServiceConcurrentB");

            initFlag = true;
        }
    }



    public static LogService getLogService() {
        if (!initFlag) {
            init();
        }

        if (initFlag && logService == null) {
            initLogService();
        }

        return logService;
    }

    public static LogService getLogServiceB() {
        if (!initFlag) {
            init();
        }

        if (initFlag && logServiceB == null) {
            initLogService();
        }

        return logServiceB;
    }

    public static <T> T getBean(String name) throws BeansException {
        return (T) context.getBean(name);
    }
}
```

å“ˆå“ˆå“ˆ ç†Ÿæ‚‰å§, ä½¿ç”¨é™æ€ä»£ç å—æ¥åˆå§‹åŒ– Spring å®¹å™¨

```java
synchronized static void init() {
    if (!initFlag) {
        context = new ClassPathXmlApplicationContext(
                "classpath*:applicationContext-jms.xml");
        initFlag = true;
    }
}
```



::: tip

å…¶å®è¿™é‡Œä½¿ç”¨ `synchronized` æ˜¯å¤šä½™çš„, å› ä¸º Classloader ä» JVM åº•å±‚ä¸Šå°±ä¿è¯äº†åŠ è½½ä¸€ä¸ªç±»çš„åŒæ­¥æ€§, é¿å…äº†å¹¶å‘é—®é¢˜.

:::

è®°ä½å“¦, è¿™é‡Œæ˜¯**ç¬¬ä¸€æ¬¡**ä½¿ç”¨ `new ClassPathXmlApplicationContext()` æ¥åˆå§‹åŒ– Spring å®¹å™¨, é…ç½®æ–‡ä»¶æ˜¯ `applicationContext-jms.xml`, åœ¨**ç¬¬äºŒæ¬¡**çš„æ—¶å€™å†è¯´è¿™ä¹ˆåšå­˜åœ¨çš„é—®é¢˜.

é‚£ä¹ˆ `logService` ä» Spring å®¹å™¨ä¸­è·å–åˆ°äº†, ç„¶åè°ƒç”¨ `saveLog()`, ä¸‹é¢æ˜¯ `saveLog()` çš„å®ç°:

```java
@Override
public boolean saveLog(String key, Object logMessage) {
    String queueName = JmsTemplateFacotry.getJmsConfig().getQueue();
    ObjectEvent objectEvent = new ObjectEvent(key, logMessage);
    return sendToMq(queueName, objectEvent);
}
```

æ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„, å°±æ˜¯ä»é…ç½®ä¸­è·å–é˜Ÿåˆ—å, ç„¶åè°ƒç”¨ `sendToMq()`, ä½†æ˜¯å¾—ä¸€æ­¥ä¸€æ­¥è·Ÿä»£ç å‘€, ä¸ç„¶æ€ä¹ˆçŸ¥é“æœ‰ä»€ä¹ˆé—®é¢˜.

```java
String queueName = JmsTemplateFacotry.getJmsConfig().getQueue();
```

é‚£æˆ‘ä»¬å°±çœ‹çœ‹ `JmsTemplateFacotry` è¿™ä¸ªç±», 

```java
public class JmsTemplateFacotry {
	private static JmsProducer jmsProducer;
	private static JmsConsumer jmsConsumer;
	private static JmsConfig jmsConfig;

	static {
		ApplicationContext context = new ClassPathXmlApplicationContext(
				"classpath*:applicationContext-jms.xml");
		jmsConfig =  (JmsConfig) context.getBean("jmsTemplateConfig");
	}

	public static void initProducer(){
		if (jmsProducer == null) {
			jmsProducer = new JmsProducer(jmsConfig.getBrokerURL(), jmsConfig.getUserName(), jmsConfig.getPassword());
		}
	}

	public static void initConsumer(){
		if(jmsConsumer == null){
			jmsConsumer = new JmsConsumer(jmsConfig.getBrokerURL(),jmsConfig.getUserName(),jmsConfig.getPassword());
		}
	}

	public static void messageSender(String queue,String jsonStr){
		initProducer();
		jmsProducer.send(queue, jsonStr);
	}

	public static JmsConsumer getJmsConsumer(){
		initConsumer();
		return jmsConsumer;
	}

	public static JmsConfig getJmsConfig(){
		return jmsConfig;
	}
}
```

ğŸ˜ çœ‹è§æ²¡,åˆæ˜¯ä¸ªé™æ€ä»£ç å—, **ç¬¬äºŒæ¬¡**é€šè¿‡ `new ClassPathXmlApplicationContext()` åˆå§‹åŒ– Spring å®¹å™¨äº†å“¦, é…ç½®æ–‡ä»¶è¿˜æ˜¯ `applicationContext-jms.xml`.

### Spring åˆå§‹åŒ–é—®é¢˜

é‚£æˆ‘ä»¬æ¥è¯´è¯´ä¸¤æ¬¡åˆå§‹åŒ– Spring å®¹å™¨çš„é—®é¢˜.

```java
ApplicationContext context = new ClassPathXmlApplicationContext(
				"classpath*:applicationContext-jms.xml");
```

å¦‚æœè°ƒç”¨å¤šæ¬¡ä¸Šé¢çš„æ–¹æ³•, å°†å¯¼è‡´åˆå§‹åŒ–å¤šä¸ª Spring å®¹å™¨

ç¬¬ä¸€ä¸ª:

![-w1130](http://qiniu.dong4j.info/2019-07-04-15520078707481.jpg)
![-w971](http://qiniu.dong4j.info/2019-07-04-15520083196922.jpg)

ç¬¬äºŒä¸ª:

![-w1022](http://qiniu.dong4j.info/2019-07-04-15520078912104.jpg)
![-w1081](http://qiniu.dong4j.info/2019-07-04-15520082941976.jpg)


ä¹Ÿå°±æ˜¯è¯´åŒä¸€ä¸ª bean ä¼šè¢«åˆå§‹åŒ– 2 æ¬¡.

::: tip

**Spring å®¹å™¨ä¸­çš„ bean é»˜è®¤æ˜¯å•ä¾‹çš„**, è¯´çš„æ˜¯**åŒä¸€ä¸ª Spring å®¹å™¨**åªèƒ½å­˜åœ¨ä¸€ä¸ªç›¸åŒçš„ bean.

:::

å¦‚æœæ˜¯ Spring + Spring MVC ç›¸åŒçš„ bean è¢«åˆå§‹åŒ–2æ¬¡, ä¼šå¯¼è‡´äº‹åŠ¡ä¸ç”Ÿæ•ˆ, @Value ä¸ç”Ÿæ•ˆç­‰å„ç§å„æ ·çš„é—®é¢˜, å› æ­¤æœ€ä½³å®è·µæ˜¯æŠŠ Spring å®¹å™¨å’Œ Spring MVC å®¹å™¨åˆ†å¼€åŠ è½½, æ¯ä¸ªå®¹å™¨åªåˆå§‹åŒ–å¯¹åº”çš„ bean.

é‡å¤çš„åˆå§‹åŒ–é€ æˆèµ„æºæµªè´¹, è€Œä¸”è¿˜ä¼šå¯¼è‡´ä¸ç¡®å®šæ€§é—®é¢˜å‡ºç°, æ‰€ä»¥ä»¥å‰è€çš„åˆå§‹åŒ–æ–¹å¼ä¸å¯å–, æ­£ç¡®çš„åšæ³•:

::: tip

å­åŒ…åªéœ€è¦æä¾›åŠŸèƒ½å³å¯, **ä¸è¦è‡ªä½œä¸»å¼ çš„åˆå§‹åŒ–**. åˆå§‹åŒ–çš„å·¥ä½œç»Ÿä¸€ç”±éƒ¨ç½²åŒ…(éœ€è¦è¿è¡Œçš„ä¸»ç±»æˆ– Web)æ¥åš, é€šè¿‡ import å­åŒ…çš„ xml é…ç½®, ç»Ÿä¸€ç”±çˆ¶å®¹å™¨æ¥ç®¡ç†æ‰€æœ‰ bean. è¿™æ ·å¯ä»¥ç»Ÿä¸€ç®¡æ§, é¿å…éšæ„åˆå§‹åŒ–. å¯¹äºé…ç½®æ–‡ä»¶ä¹Ÿæ˜¯è¿™ä¸ªé“ç†.

:::

### å¹¶å‘é—®é¢˜

è¯´äº†è¿™ä¹ˆå¤š, ç»ˆäºè¦è¯´æ ¹æœ¬çš„é—®é¢˜äº†.

LogServiceAsyncJmsImpl å¼‚æ­¥å‘ mq ä¸­å‘é€å¼‚å¸¸æ—¥å¿—çš„æ–¹æ³•

```java
private boolean sendToMq(String queue, ObjectEvent objectEvent) {
    try {
        String jsonEvent = objectEvent.getKey()
                + "-"
                + JsonUtil.objectToJson(objectEvent
                .getMsg());
        // æ³¨æ„é‡ç‚¹ä»£ç 
        JmsTemplateFacotry.messageSender(queue, jsonEvent);
        return true;
    } catch (Exception ex) {
        log.error("JmsTemplateFacotry messageSender Error : {}", ex.getMessage());
    }
    return false;
}
```

messageSender() çš„å®ç°

```java
public static void messageSender(String queue,String jsonStr){
		initProducer();
		jmsProducer.send(queue, jsonStr);
}

public static void initProducer(){
	if (jmsProducer == null) {
		jmsProducer = new JmsProducer(jmsConfig.getBrokerURL(), jmsConfig.getUserName(), jmsConfig.getPassword());
	}
}	
```

`messageSender()` ä¼šå…ˆåˆ¤æ–­ jmsProducer æ˜¯å¦ä¸º null, ä¸º null å°±å®ä¾‹åŒ–ä¸€ä¸ª `JmsProducer` å¯¹è±¡, å®ä¾‹åŒ– `JmsProducer` å¯¹è±¡æ—¶, ä¼šè°ƒç”¨ä¸Šé¢åˆ›å»ºçº¿ç¨‹æ± çš„ `init()`.

çœ‹ç€æ˜¯ä¸ªå¾ˆåˆç†çš„é€»è¾‘, ä½†æ˜¯å´æ²¡æœ‰è€ƒè™‘**å¹¶å‘**çš„é—®é¢˜. å¦‚æœæ˜¯å¤šçº¿ç¨‹, ä¼šå‡ºç°ä¸Šé¢æƒ…å†µ? 
åœ¨åˆ†æä¹‹å‰, å…ˆæ¥å¤ä¹ ä¸‹ä½¿ç”¨ new åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„è¿‡ç¨‹:

![NewInstance](http://qiniu.dong4j.info/2019-07-04-NewInstance.png)

ä¸€ä¸ªç±»è¢« JVM åŠ è½½çš„æ—¶æœº:

1. ä½¿ç”¨ new å…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™;
2. è¯»å–æˆ–è®¾ç½®è¿™ä¸ªç±»çš„é™æ€å­—æ®µ(è¢«finalä¿®é¥°ï¼Œå·²åœ¨ç¼–è¯‘å™¨æŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–)çš„æ—¶å€™;
3. è°ƒç”¨è¿™ä¸ªç±»çš„é™æ€æ–¹æ³•çš„æ—¶å€™;
4. ä½¿ç”¨ java.lang.reflect åŒ…å¯¹è¿™ä¸ªç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™;
5. å½“è™šæ‹Ÿæœºå¯åŠ¨, ç›´æ¥æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ç±»(ä¹Ÿå°±æ˜¯åŒ…å« main() çš„ä¸»ç±»);

ä¸Šé¢æ˜¯ç±»çš„åˆå§‹åŒ–çš„ 5 ç§æƒ…å†µ, é€šè¿‡é˜…è¯» `JmsProducer` ç±»çš„ä»£ç , æˆ‘ä»¬å¯ä»¥ç¡®å®š**ç¬¬ä¸€æ¬¡åˆå§‹åŒ–** `JmsProducer` æ—¶, å°±æ˜¯é€šè¿‡ new å…³é”®å­—. å› æ­¤å…ˆæ‰§è¡Œ `JmsProducer` çš„åˆå§‹åŒ–æµç¨‹, æœ€ç»ˆåˆ›å»º `JmsProducer` ç±»çš„ class å¯¹è±¡. 
æ³¨æ„å“¦, å¦‚æœä¸€å¼€å§‹ JVM æ²¡æœ‰åŠ è½½è¿‡ `JmsProducer` è¿™ä¸ªç±», ä¼šå…ˆå¯¹ç±»è¿›è¡ŒåŠ è½½ä»è€Œç”Ÿæˆå½“å‰ç±»çš„ class å¯¹è±¡, å¹¶ä¸ä¼šç”Ÿæˆ `JmsProducer` ç±»çš„å®ä¾‹å¯¹è±¡.

ä»¥ä¸Šæµç¨‹, JVM éƒ½èƒ½ä¿è¯æ˜¯åŒæ­¥çš„,  å› æ­¤åŒä¸€ä¸ªç±»å‹åªèƒ½è¢«**åŒä¸€ä¸ªç±»åŠ è½½å™¨**åŠ è½½ä¸€æ¬¡.

::: tip

å…·ä½“å¯è§ ã€Œæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€ç¬¬ 7 ç« 

:::

åªæœ‰å½“ä½¿ç”¨ `new` å…³é”®å­—æ—¶, å¦‚æœæ²¡æœ‰è¢« JVM åˆå§‹åŒ–å°±èµ°ä¸Šé¢çš„æµç¨‹, å¦‚æœå·²è¢«åˆå§‹åŒ–äº†, æ‰å¼€å§‹èµ°**ç±»çš„å®ä¾‹åŒ–æµç¨‹**, 

![-w739](http://qiniu.dong4j.info/2019-07-04-15520104037450.jpg)

é‚£æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™æ®µä»£ç åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ä¼šå‡ºç°ä¸Šé¢é—®é¢˜:

```java
public static void initProducer(){
	if (jmsProducer == null) {
		jmsProducer = new JmsProducer(jmsConfig.getBrokerURL(), 
                                  jmsConfig.getUserName(), 
                                  jmsConfig.getPassword());
	}
}	
```

**å…ˆè¯´ç¬¬ä¸€ä¸ªå¥½ç†è§£çš„æƒ…å†µ:**

å› ä¸ºæ˜¯å¤šçº¿ç¨‹ç¯å¢ƒ, å¯èƒ½åŒæ—¶å¤šä¸ªçº¿ç¨‹ä¸€èµ·è¿›å…¥ if åˆ¤æ–­é€»è¾‘, å› ä¸º `jmsProducer == null` ä¸º true, ä¼šæ‰§è¡Œå¤šæ¬¡å®ä¾‹åŒ–æµç¨‹.

**å…ˆæ¥è¯´è¯´å¦ä¸€ä¸ªå¤æ‚ç‚¹çš„æƒ…å†µ:**

å½“ç¬¬ä¸€æ¬¡æ‰§è¡Œ `JmsTemplateFacotry.initProducer()` æ—¶, `jmsProducer == null` .
å½“ **çº¿ç¨‹1** è¿›å…¥ if åˆ¤æ–­, ç”±äº `jmsProducer == null` ä¸º true, ä¼šæ‰§è¡Œå®ä¾‹åŒ–æµç¨‹.
è¿™ä¸ªæ—¶å€™ **çº¿ç¨‹2** è¿›å…¥ if åˆ¤æ–­é€»è¾‘, ç”±äºå®ä¾‹åŒ–æµç¨‹ä¹Ÿéœ€è¦æ—¶é—´, åœ¨è¿˜æ²¡æœ‰å®ä¾‹åŒ–å®Œæˆä¹‹å‰, `jmsProducer == null` ä¸º true, å› æ­¤ **çº¿ç¨‹2** ä¼šå†æ¬¡å®ä¾‹åŒ–ä¸€ä¸ª `jmsProducer`.

æ€»ç»“ä¸€ä¸‹å®ä¾‹åŒ–å¯¹è±¡çš„è¿‡ç¨‹:

1. åˆ†é…å†…å­˜  
2. åˆå§‹åŒ–å¯¹è±¡ï¼ˆå†…å­˜èµ‹å€¼ï¼‰  
3. å†…å­˜åœ°å€èµ‹ç»™ instance ï¼ˆinstance != nullï¼‰

ä»¥ä¸ŠåŸå› ä¹Ÿå°±ç›´æ¥**å¯¼è‡´äº†åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ± ** !!!

å°±è¿™ä¹ˆç®€å•, ç”±äºå¤šçº¿ç¨‹å¹¶å‘æ‰§è¡ŒåŒä¸€æ®µä»£ç . åšäº‹è¦éªŒè¯, é‚£æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹

```java
@Test
public void test1() throws InterruptedException {

    for (int index = 0; index < 1000; index++) {
        new Thread(new Runnable() {
            public void run() {
                try {
                    log.info("jsmProducer = {}", JmsTemplateFacotry.getJmsProducer());
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }).start();

    }

    Thread.currentThread().join();
}
```

è¾“å‡º:

```
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@546dd457
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@63666aa6
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@63a9e6ce
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@65da9f79
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@3c657f0b
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@679c614
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@619ef7cf
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@27081999
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@1e4acc1c
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@52370b34
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@e8a0743
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@d882d64
....
```

å¯¹å§, å®ä¾‹åŒ–äº†å¥½å¤šæ¬¡å§

## è§£å†³é—®é¢˜

çŸ¥é“äº†é—®é¢˜æ‰€åœ¨, è§£å†³é—®é¢˜å°±å¾ˆå®¹æ˜“äº†, æˆ‘ä»¬åªéœ€è¦ä¿è¯ `JmsProducer` æ˜¯å•ä¾‹çš„å°±å¯ä»¥äº†

[**å•ä¾‹çš„æ‰€æœ‰å†™æ³•ä¼šäº†å—?**](http://interview.dong4j.info/design-patterns/singleton.html)

è¿™é‡Œåªä½¿ç”¨æœ€å¯é æœ€ç®€å•çš„ä¸€ç§æ–¹å¼: **æšä¸¾** (ç¬¬äºŒä¸ªæ¨èé™æ€å†…éƒ¨ç±», ä¸æ¨è DCL, å› ä¸º DCL å¹¶ä¸å®Œå…¨å¯é )

```java
/**
 * <p>Company: ç§‘å¤§è®¯é£è‚¡ä»½æœ‰é™å…¬å¸-å››å·åˆ†å…¬å¸</p>
 * <p>Description: æšä¸¾å•ä¾‹è·å– JmsProducer, ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹</p>
 *
 * @author dong4j
 * @date 2019-03-08 11:04
 * @email sjdong3@iflytek.com
 */
public enum JmsProducerEnum {
    INSTANCE;

    private JmsProducer instance;

    private JmsConfig jmsConfig;

    public void setJmsConfig(JmsConfig jmsConfig){
        this.jmsConfig = jmsConfig;
    }

    public JmsProducer getInstance() {
        if(instance == null){
            instance = new JmsProducer(jmsConfig.getBrokerURL(), jmsConfig.getUserName(), jmsConfig.getPassword());
        }
        return instance;
    }
}
```

æµ‹è¯•ä¸€ä¸‹:

```java
@Test
public void test2() throws InterruptedException {

    for (int index = 0; index < 1000; index++) {
        new Thread(new Runnable() {
            public void run() {
                try {
                    JmsProducerEnum instance = JmsProducerEnum.INSTANCE;
                    instance.setJmsConfig(JmsTemplateFacotry.getJmsConfig());
                    log.info("jsmProducer = {}", instance.getInstance());
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }
    Thread.currentThread().join();
}
```

è¾“å‡º:

```
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
...
```

æœ€ç»ˆçš„ä¿®æ”¹æ–¹æ¡ˆ

```java
public class JmsTemplateFacotry {
	private static JmsProducer jmsProducer;
	private static JmsConsumer jmsConsumer;
	private static JmsConfig jmsConfig;

	static {
		ApplicationContext context = new ClassPathXmlApplicationContext(
				"classpath*:applicationContext-jms.xml");
		jmsConfig =  (JmsConfig) context.getBean("jmsTemplateConfig");

		JmsProducerEnum instance = JmsProducerEnum.INSTANCE;
		instance.setJmsConfig(jmsConfig);
		jmsProducer = instance.getInstance();
	}

    ...
}
```

è¿™é‡Œè¿˜ç”¨äº†åŒé‡ä¿è¯, JVM ä¿è¯ static ä»£ç å—åªæ‰§è¡Œä¸€æ¬¡, æšä¸¾å•ä¾‹å†ä¿è¯å”¯ä¸€å®ä¾‹.

## ä¸ºä»€ä¹ˆä¼šå‡ºç°å¹¶å‘é—®é¢˜

`BiUserStatusTask` ç±»ä¸­çš„åˆå§‹åŒ–ä»£ç 

```java
@Override
public void init() {
    ringAdapter = (RingAdapter) DataCache.getContext().getBean("ringAdapter");
    JmsConfig producerJmsConfig = new JmsConfig();
    producerJmsConfig.setBrokerURL(MQ_URL);
    producerJmsConfig.setUserName(MQ_USER_NAME);
    producerJmsConfig.setPassword(MQ_USER_PASSWORD);
    jmsProducerFactory = new JmsProducerFactory(producerJmsConfig);
    JmsConfig consumerJmsConfig = new JmsConfig();
    consumerJmsConfig.setBrokerURL(MQ_URL);
    JmsConsumerFactory jmsConsumerFactory = new JmsConsumerFactory(consumerJmsConfig);
    jmsConsumerFactory.getJmsConsumer().setQueue(MQ_SIGNAL_NAME);
    jmsConsumerFactory.getJmsConsumer().setQueuePrefetch(Integer.valueOf(QUEUE_SIZE));
    jmsConsumerFactory.getJmsConsumer().setMessageListener(new MultiThreadMessageListener(Integer.parseInt(MQ_THREAD), new MessageHandler() {
        @Override
        public void handle(Message message) {
            try {
                logger.debug("æ‰§è¡Œä»»åŠ¡ï¼š" + taskName + "ä¼‘çœ ï¼");
                Thread.sleep(Integer.parseInt(MQ_SLEEP));
                getUserStatusData(message);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }));
    try {
        jmsConsumerFactory.getJmsConsumer().start();
    } catch (Exception e) {
        logger.error(CommonFunc.getExceptionStack(e));
        LogSupportException.writeFuncExceptionLog(e, "å¼‚æ­¥å·¥å…·", "run-BiUserStatusTask", this.getClass().getSimpleName(), LogSupportException.ErrorLevel.ERROR);
    }
}
```

ç”¨äºæ¥æ”¶ `BiUserStatusSignal` é˜Ÿåˆ—æ¶ˆæ¯çš„æ¶ˆè´¹è€…ä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹æ± , åœ¨ `MessageListener` é‡Œé¢, å½“æ‹¿åˆ°ä¸€æ‰¹æ¶ˆæ¯å, ä¼šé€šè¿‡**å¤šçº¿ç¨‹**æ¥å¤„ç†, ä¹Ÿå°±æ˜¯ `getUserStatusData()` æ–¹æ³•, å½“è¿™ä¸ªæ–¹æ³•è¿›å…¥ catch æ—¶, æœ€ç»ˆä¼šé€šè¿‡ `JmsTemplateFacotry` æ¥å‘é€æ¶ˆæ¯, ç„¶ååœ¨å®ä¾‹åŒ– `JmsProducer` æ—¶æ²¡æœ‰è€ƒè™‘åˆ°å¤šçº¿ç¨‹é—®é¢˜, å¯¼è‡´åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ± .

## å¯é çš„å•å…ƒæµ‹è¯•

`iconmons-mq` è¿™ä¸ªç»„ä»¶åªæµ‹è¯•äº† `JMSProducer` å’Œ `JMSConsumer`, å´æ²¡æœ‰æµ‹è¯•å‡ ä¸ª Factory ç±», è€Œä¸”å•å…ƒæµ‹è¯•åº”è¯¥ä½¿ç”¨ Junit, **ä¸è¦ä½¿ç”¨ main()**, æ›´ä¸è¦ä½¿ç”¨ `System.out.println`. 
å°½é‡åšåˆ°è§„èŒƒåŒ–, å¯æµ‹è¯•åŒ–.

ä¸ºä»€ä¹ˆ `JMSProducer` æµ‹è¯•äº† 100w æ¬¡ä¹Ÿæ²¡é—®é¢˜, å› ä¸ºæ˜¯é€šè¿‡æ‰‹åŠ¨ new çš„æ–¹å¼åˆ›å»º, è€Œä¸”åªæœ‰ä¸€æ¬¡, è¿™æ ·å°±ä¿è¯äº† JMSProducer å•ä¾‹.

æœ€åè¿›è¡Œé›†æˆæµ‹è¯•

![-w623](http://qiniu.dong4j.info/2019-07-04-15520175081138.jpg)

æ²¡å†å‡ºç°é”™è¯¯æ—¥å¿—

è¿è¡Œæ—¶æ•°æ®:

![-w1440](http://qiniu.dong4j.info/2019-07-04-15520167800260.jpg)

é•¿æ—¶é—´è¿è¡Œ, GC æ¬¡æ•°å°‘, çº¿ç¨‹æ•°ä¿æŒåœ¨ 117.

## é—®é¢˜æ€»ç»“

![ç¬”è®°æœ¬ -5--9](http://qiniu.dong4j.info/2019-07-04-%E7%AC%94%E8%AE%B0%E6%9C%AC%20-5--9.jpg)

é€šè¿‡è¿™æ¬¡çš„é—®é¢˜ä¿®å¤, æˆ‘ä»¬æ¶‰åŠåˆ°äº†, å¹¶å‘, çº¿ç¨‹æ± , ç±»çš„åˆå§‹åŒ–, ç±»çš„å®ä¾‹åŒ–, Spring å®¹å™¨çš„åˆå§‹åŒ–ç­‰ç›¸å…³çŸ¥è¯†ç‚¹, ä¹Ÿæ¸…æ¥šäº†è¯´æ˜äº†è€ä»£ç ä¸­å­˜åœ¨çš„ä¸€äº›æ¡†æ¶é—®é¢˜.

## å¯¹äº 12530 é‡æ„çš„æƒ³æ³•

ä¸ªäººè§‰å¾—è€æ¡†æ¶ä¸éœ€è¦æ”¹äº†, çœŸæ”¹ä¸åŠ¨äº†, å¦‚æœæ²¡æœ‰æ”¹å®Œæˆ–è€…æ²¡æœ‰ç»è¿‡å¤§é‡çš„æµ‹è¯•, æ˜¯å¾ˆå®¹æ˜“å‡ºç°é—®é¢˜çš„.

ä¸»è¦æ˜¯ä»¥å‰çš„ä»£ç ç»“æ„å¤ªçƒ‚, æ¡†æ¶ç»“æ„ä¹Ÿä¸åˆç†, æœ€é‡è¦çš„æ˜¯ç›¸å…³ä¾èµ–ç®¡ç†å¤ªéšæ„äº†, æ ¹æœ¬å°±æ²¡æœ‰**ç®¡ç†**.å„ç»„ä»¶çš„ç‰ˆæœ¬ç®¡ç†ä¹Ÿä¸è§„èŒƒ, å¯¼è‡´åæœŸç»´æŠ¤æ€§å¤§æ‰“æŠ˜æ‰£. ç°åœ¨èƒ½åšçš„å°±æ˜¯åœ¨ä¸åŠ¨ä¸»ä½“æ¡†æ¶çš„æƒ…å†µä¸‹, å°½é‡é‡æ„ä»£ç . 

å½“ç„¶æˆ‘ä»¬ä¹Ÿåšè¿‡è¿™æ–¹é¢çš„åŠªåŠ›, é‡æ„é¡¹ç›®ä¾èµ–ç®¡ç†, é‡æ„æ—¥å¿—, é‡æ„é…ç½®, é‡æ„ç»„ä»¶, ä½†æ˜¯æ”¹å‡ºæ¥çš„ä¸œè¥¿å´ä¸å°½äººæ„, ç»™å…¶ä»–åŒäº‹é€ æˆäº†å·¥ä½œä¸Šçš„è´Ÿæ‹…. ä¸è¿‡è¿™æ˜¯é‡æ„é˜¶æ®µå¿…é¡»è¦ç»å†çš„æƒ…å†µ.

12530 ä¸šåŠ¡å¤š, ä»£ç å¤š, ç»„ä»¶å¤š, åŸºæœ¬ä¸Šæ˜¯ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«, å› æ­¤åœ¨æ²¡æœ‰å¤§é‡æµ‹è¯•çš„æƒ…å†µä¸‹, å¾ˆéš¾ä¿è¯é‡æ„åçš„æ­£ç¡®æ€§ä¸ç¨³å®šæ€§.

å› æ­¤æŒ‰ç…§æˆ‘çš„å»ºè®®å°±æ˜¯ä¸è¦æ”¹è€ä»£ç äº†, æŠŠä¸šåŠ¡è¿ç§»åˆ° `ms-project` ä¸Šæ¥, è‡³å°‘ä¾èµ–ç®¡ç†, é…ç½®ç®¡ç†, æ—¥å¿—ç®¡ç†è¿™äº›åšçš„æ¯”è€æ¡†æ¶å¥½, ä»£ç ä¹Ÿæ›´è§„èŒƒ.

æ€ä¹ˆé‡æ„ä»£ç ä»¥å‰æˆ–å¤šæˆ–å°‘è¯´è¿‡ä¸€ç‚¹, è¿™é‡Œå†é‡ç”³ä¸€ä¸‹:

**åªè¦æŠŠ IDEA æç¤ºçš„è­¦å‘Šæ”¹å®Œå°±å¯ä»¥äº†**, è¿™ç§é‡æ„æ˜¯å¯¹ä¸šåŠ¡å’Œæµ‹è¯•å½±å“æœ€å°çš„æ–¹å¼. ä»¥å‰ä¹Ÿè¯´è¿‡æ€ä¹ˆé€šè¿‡ä¿®æ”¹è­¦å‘Šæ¥å­¦ä¹ åº•å±‚çš„çŸ¥è¯†, ä¸ºä»€ä¹ˆ IDEA å¯¹è¿™æ®µä»£ç æå‡ºè­¦å‘Š, æœ‰æ²¡æœ‰æ›´å¥½çš„æ›´è§„èŒƒçš„ä»£ç å®ç°è¿™æ®µé€»è¾‘?

åœ¨å†™ä¸šåŠ¡é€»è¾‘çš„æ—¶å€™æ˜¯ä¸æ˜¯æ²¿ç”¨ä»¥å‰çš„ä»£ç è§„èŒƒå’Œæ€è€ƒé€»è¾‘? ä»¥å‰çš„ä»£ç å°±ä¸€å®šæ­£ç¡®å—? æœ‰æ²¡æœ‰ä¼˜åŒ–çš„ç©ºé—´å‘¢?

ä¸¾ä¸ªä¾‹å­:

åœ¨åšç²¾å‡†è¥é”€çš„æ—¶å€™, å…ˆæŠŠç›¸å…³ä»£ç æ‹ä¸€é, æ¸…æ¥šä¸ªå¤§æ¦‚é€»è¾‘, ä¸éœ€è¦æ·±å…¥çœ‹ä»£ç .

**ç¬¬ä¸€é: æŠŠé‡åˆ°çš„æ‰€æœ‰è­¦å‘Šæç¤ºçœ‹ä¸€é**

```java
Map<String, String> inputStrings = new HashMap<String, String>();
```

è¿™æ®µä»£ç æœ‰é—®é¢˜å—? IDEA å·²ç»ç»™å‡ºäº†æç¤º

1. `new HashMap<String, String>` å¯ä»¥ç®€åŒ–ä¸º `new HashMap<>`;
2. åˆå§‹åŒ– HashMap æ—¶è®¾ç½®åˆå§‹å¤§å°;

å¦‚æœä½ çœ‹åˆ°è¿™ä¸ªæç¤º, ä½ ä¼šä¸ä¼šæƒ³ä¸ºä»€ä¹ˆèƒ½ç®€åŒ–æˆ `new HashMap<>`?
ä¸ºä»€ä¹ˆæœ€å¥½ä¸º HashMap è®¾ç½®åˆå§‹å€¼?

ä½ å°±ä¼šå»æŸ¥èµ„æ–™, å› ä¸º JDK7 çš„æ–°ç‰¹æ€§, å«é’»çŸ³è¯­æ³•, é‚£ä¹ˆä½ è¿˜å¯ä»¥æŸ¥ä¸€ä¸‹ JDK7 å…¶ä»–æ–°çš„è¯­æ³•, çœ‹æ˜¯å¦èƒ½ç”¨åˆ°é¡¹ç›®ä¸­.
ç»™ HashMap è®¾ç½®åˆå§‹å€¼æ˜¯ä¸ºäº†åˆç†åˆ†é…å†…å­˜, å‡å°‘ resize çš„æ¬¡æ•°, ä»è€Œæé«˜æ•ˆç‡.
é‚£ä½ å°±ä¼šå»çœ‹ HashMap æºç , ä½ å°±ä¼šçŸ¥é“:

1. ä»€ä¹ˆæƒ…å†µä¸‹å› resize; 
2. resize åçš„å®¹é‡æ˜¯å¤šå°‘; 
3. è´Ÿè½½å› å­åˆæ˜¯ä»€ä¹ˆ; 
4. ä¸ºä»€ä¹ˆ HashMap ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„;
5. æœ‰æ²¡æœ‰çº¿ç¨‹å®‰å…¨çš„ HashMap, æœ‰å“ªäº›;
6. HashMap çš„å­˜å‚¨æ–¹å¼æ˜¯æ€æ ·çš„; JDK7 å’Œ JDK8 çš„å®ç°æ–¹å¼æœ‰ä»€ä¹ˆä¸åŒ;
7. å¦‚æœ key æ˜¯å¯¹è±¡ä¸ºä»€ä¹ˆè¦é‡å†™ hashCode() å’Œ equals()æ–¹æ³•; 
8. ä¸ºä»€ä¹ˆ HashMap ä¸€èˆ¬ä½¿ç”¨ String åš key;
9. ....

ç„¶åå†æ·±å…¥ä¸€äº›:

1. åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹, ä½¿ç”¨ HashMap å­˜åœ¨çš„é—®é¢˜;
2. HashMap ä¸ ConcurrentHashMap çš„åŒºåˆ«; ConcurrentHashMap åˆæ˜¯æ€ä¹ˆå®ç°çš„;
3. èƒ½ä¸èƒ½è¯´å‡º put() çš„é€»è¾‘;
4. æ›´æ·±å…¥çš„äº†è§£ hashCode() çš„ä½œç”¨;
5. è‡ªå·±è®¾è®¡ä¸€ä¸ª hash æ–¹æ³•, å‡å°‘ hash ç¢°æ’;
6. èƒ½é€šè¿‡ä»€ä¹ˆæ–¹å¼æé«˜ HashMap çš„æŸ¥è¯¢æ•ˆç‡;
7. ....

é‚£è¯´åˆ° String, åˆå¯ä»¥å»çœ‹ String çš„æºç äº†, ç„¶åä½ å°±ä¼šæ˜ç™½:

1. ä¸ºä»€ä¹ˆ String æ˜¯ä¸å¯å˜ç±»; è‡ªå·±æ€ä¹ˆè®¾è®¡ä¸€ä¸ªä¸å¯å˜ç±»;
2. ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å¾ªç¯é‡Œé¢ä¸ä½¿ç”¨ `+` æ¥æ‹¼æ¥å­—ç¬¦ä¸²;
3. ä¸ StringBuffer, StringBuilder çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ;
4. ...

ç„¶åå†æ·±å…¥ä¸€äº›:

1. String çš„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ä½ç½®;
2. ä» JDK6 å¼€å§‹, æ˜¯æ€ä¹ˆä¼˜åŒ– String çš„;
3. String çš„ä¸å¯å˜æ€§æ˜¯ç»å¯¹çš„å—? å¯ä¸å¯ä»¥ä½¿ç”¨ä¸€äº›æ‰‹æ®µä¿®æ”¹ String;
4. ....

**å°±çœ‹ 1 è¡Œä»£ç , ä½ èƒ½è”æƒ³åˆ°è¿™äº›é—®é¢˜å—?**

ä¸æ˜¯è¯´åªå†™ä¸šåŠ¡ä»£ç å°±ä¸èƒ½å­¦åˆ°ä¸œè¥¿, å­¦ä¸œè¥¿åœ¨å“ªå„¿éƒ½å¯ä»¥å­¦åˆ°, åªè¦æœ‰è¿™ä¸ªå¿ƒå°±è¡Œ.

å…ˆæŠŠåŸºç¡€çŸ¥è¯†å­¦å¥½äº†, æ¡†æ¶è¿™äº›éƒ½æ˜¯é”¦ä¸Šæ·»èŠ±çš„äº‹.

**ç¬¬äºŒé: æŠŠä»£ç ç»“æ„æ¢³ç†ä¸€é**

ç®€å•çš„é‡æ„ä»ç¬¬äºŒéå¼€å§‹, ä¸€ä¸ªæ–¹æ³•è¶…è¿‡ **80** è¡Œ, å°±è¯¥æ‹†åˆ†äº†.

1. æœ‰æ²¡æœ‰ä»£ç æ˜¯å…±ç”¨çš„?
2. èƒ½ä¸èƒ½æŠ½ç¦»æˆå·¥å…·ç±»?
3. æ³¨é‡Šå†™å¥½äº†å—?
4. ä»£ç é€»è¾‘æ¸…æ™°äº†å—?
5. æ³¨é‡Šæ‰çš„ä»£ç åˆ æ²¡åˆ ? ç•™ç€å¹²å˜›? ç®—ä»£ç è¡Œæ•°? æˆ‘ä»¬æœ‰ç‰ˆæœ¬ç®¡ç†, ä¸è¦çš„è¯·ç›´æ¥åˆ é™¤.
6. å­—æ®µå, æ–¹æ³•åå‘½åè§„èŒƒå—?
7. æœ‰é­”æ³•å€¼å—?
8. tay-catch åˆç†åŒ…è£¹åˆç†å—? å¼‚å¸¸å¤„ç†æ–¹å¼åˆç†å—? æœ‰æ²¡å¤„ç†åˆ°çš„å¼‚å¸¸å—?
9. å¿…è¦çš„æ—¥å¿—æ‰“å°äº†å—? æ—¥å¿—ç­‰çº§è®¾ç½®åˆç†å—?
10. é‡è½½çš„æ–¹æ³•å†™ `@Override` æ³¨é‡Šäº†å—?
11. æ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦åˆç†å—? è¿”å›å€¼åˆç†å—? å…¥å‚åˆç†å—?
12. switch case åˆ°äº†å…¨éƒ¨æƒ…å†µå—?
13. if åˆ¤æ–­åˆç†å—?
14. return çš„åœ°æ–¹åˆç†å—?
15. ...


æŠŠä½ çœ‹åˆ°çš„ä¸åˆç†çš„åœ°æ–¹å…¨éƒ¨é‡æ„äº†, è¿™ä¸€æ­¥ä¹Ÿå…¨éƒ¨æ˜¯å€ŸåŠ© IDEA å¼ºå¤§çš„é‡æ„åŠŸèƒ½, æ¯”å¦‚é€‰ä¸­ä½ æƒ³æŠ½ç¦»ä¸ºæ–¹æ³•çš„ä»£ç , `ctl + shift + m` (windows çš„å¿«æ·é”®ä¸æ¸…æ¥š, å¥½åƒæ˜¯è¿™ä¸ª)è‡ªåŠ¨é‡æ„, åªéœ€è¦å‘½åå°±å¯ä»¥äº†

![-w636](http://qiniu.dong4j.info/2019-07-04-15520229273664.jpg)

å…¶ä»–çš„é‡æ„å¿«æ·é”®å’ŒåŠŸèƒ½è‡ªå·±å»äº†è§£å’Œä½¿ç”¨.

**æŠŠåƒé¥­çš„å·¥å…·ä½¿ç”¨ç†Ÿç»ƒæ˜¯æœ€åŸºæœ¬çš„è¦æ±‚**, ç„¶åå°±æ˜¯æ•ˆç‡é—®é¢˜, **èƒ½è‡ªåŠ¨åŒ–ç»ä¸æ‰‹åŠ¨, èƒ½èŠ‚çº¦ 1ç§’ æ—¶é—´çš„äº‹, æˆ‘å®æ„¿è¯ 1 ä¸ªå°æ—¶æ¥å­¦ä¹ .**

ç°åœ¨ä½¿ç”¨çš„å·¥å…·æœ‰æ²¡æœ‰æ›´å¥½çš„å·¥å…·å¯ä»¥æ›¿ä»£? æœ‰æ²¡æœ‰å»äº†è§£è¿‡åŒç±»å·¥å…·? 
è¯·è®°ä½, **å·¥å…·å°±æ˜¯ä½ çš„å…µå™¨**, ä¸€æŠŠè¶æ‰‹çš„å…µå™¨æ¯”æ‰‹æ— å¯¸é“å¥½å¾—å¤š

**ç¬¬ä¸‰é: æ¢³ç†ä¸šåŠ¡é€»è¾‘**

è¿™ä¸€éå°±å¯ä»¥å¼€å§‹å¼€å‘ä¸šåŠ¡äº†.
äº†è§£éœ€æ±‚, å…ˆæƒ³æ€ä¹ˆå†™, ä¸è¦ä¸€ä¸Šæ¥å°±å¼€å§‹å†™ä»£ç , æƒ³ä¸€ä¸ªæ–¹æ¡ˆå‡ºæ¥, ç›¸å…³çš„å•å…ƒæµ‹è¯•å†™å‡ºæ¥, å†æƒ³æƒ³:

1. è¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„å®ç°æ–¹å¼?
2. ä»¥å‰çš„ä»£ç å­˜åœ¨çš„é—®é¢˜?
3. ä»¥å‰çš„é€»è¾‘è¿˜èƒ½æ€æ ·ä¼˜åŒ–?
4. ä»¥å‰çš„æ¥å£å®šä¹‰åˆç†å—?
5. èƒ½ä¸èƒ½è¿ç”¨åˆ°è®¾è®¡æ¨¡å¼æŠŠä¸šåŠ¡æŠ½ç¦»å‡ºæ¥? æé«˜ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§?
6. ....

è¿™éƒ¨åˆ†æ²¡æœ‰å¤ªå¤šè¯è¯­æƒ, æ¯•ç«Ÿåšçš„å°‘. ä¸¾ä¸ªä¾‹å­å§:

![7D088AFA086A607BEC9864A0A89F31B4](http://qiniu.dong4j.info/2019-07-04-7D088AFA086A607BEC9864A0A89F31B4.jpg)

![F8CE288A6E38D46565D71B0A00D27F24](http://qiniu.dong4j.info/2019-07-04-F8CE288A6E38D46565D71B0A00D27F24.jpg)

ä¸æ˜¯ä»£ç å†™å¾—è¶Šå¤šå°±è¶Šå¥½, ä¸æ˜¯æ–¹æ³•è¶Šå¤šä»£ç ç»“æ„å°±æ¸…æ™°.

![-w1915](http://qiniu.dong4j.info/2019-07-04-15520240417737.jpg)

ä¸è¦æŒ‰ç…§ä»¥å‰è€çš„æ€è·¯æ¥å†™ä»£ç , è¦æœ‰è‡ªå·±çš„æ€è€ƒ.
ä»¥å‰çš„é€»è¾‘åˆç†å—? æ¥å£è§„èŒƒåˆç†å—? è¿”å›ç»“æœåˆç†å—?

![70C9386E0369D3F1837F611BBB843072](http://qiniu.dong4j.info/2019-07-04-70C9386E0369D3F1837F611BBB843072.png)

ä¸šåŠ¡ç«¯ä¼ å…¥ servicedId æ¥æŸ¥æŒ‡å®šçš„ä¸šåŠ¡çš„è®¢è´­çŠ¶æ€, ä¸ºä»€ä¹ˆè¿˜è¦é€šè¿‡æ¥å£çš„ serviceId è¿”å›ç±»å‹æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯æŸ¥è¯¢çš„å½“å‰ä¸šåŠ¡? éš¾é“æˆ‘æŸ¥è¯¢çš„ä»€ä¹ˆä¸šåŠ¡è¿˜è¦é€šè¿‡æ¥å£æ¥å‘Šè¯‰æˆ‘å—?

é‚£ä¼ ä¸ª serviceId è¿˜æœ‰ä»€ä¹ˆæ„ä¹‰? 

å½“ç„¶è¿™é‡Œä¹Ÿæœ‰å†å²åŸå› , æˆ–è€…éƒ½å¯ä»¥è¯´å…¨éƒ¨æ˜¯å†å²åŸå› , ä½†æ˜¯æˆ‘ä»¬ç°åœ¨å¯ä»¥æ”¹å˜, å¯ä»¥é‡æ„, ä¸ºäº†æ›´å¥½çš„å°†æ¥, ä¸ºäº†ä¸‹ä¸€æ‰¹ç»´æŠ¤è€…å°‘æ‰å‘é‡Œé¢, è¿™äº›éƒ½å¯ä»¥æ”¹....

å†™å¾—ä»£ç ä¸æ˜¯**èƒ½è·‘é€š**å°±å¯ä»¥äº†(ã€Œåˆä¸æ˜¯ä¸èƒ½è·‘ã€ ğŸ˜³), éœ€è¦æ€è€ƒå’Œåæ€. 

æœ€åå¤šå›é¡¾è‡ªå·±çš„ä»£ç , éšç€è‡ªå·±çŸ¥è¯†é¢çš„æ‰©å±•, çŸ¥è¯†ç‚¹çš„åŠ æ·±, å†çœ‹çœ‹ä»¥å‰çš„ä»£ç æ˜¯ä¸æ˜¯åˆæœ‰æ›´å¥½çš„å®ç°æ–¹å¼, å†æ¬¡é‡æ„å•Š.